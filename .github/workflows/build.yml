name: Build Static HAProxy for Debian  # 工作流名称

on:  # 触发条件
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

jobs:  # jobs 顶级键，包含所有 job
  # trixie job：Debian 13，依赖 bookworm 成功
  build-trixie:
    runs-on: ubuntu-latest
    container: debian:trixie  # 使用 Debian 13 镜像
    steps:
    - name: Checkout repository  # 检出仓库代码
      uses: actions/checkout@v4

    - name: Install build dependencies  # 安装构建依赖
      run: |
        apt-get update
        apt-get install -y build-essential wget make tar perl git

    - name: Build LUA (static)  # 构建 LUA 
      run: |
        LUA_VERSION=5.4.8
        wget https://www.lua.org/ftp/lua-${LUA_VERSION}.tar.gz
        tar xzf lua-${LUA_VERSION}.tar.gz
        cd lua-${LUA_VERSION}
        make -j$(nproc) all
        make install
        cd ..
  
    - name: Build jemalloc  # 构建 jemalloc 不支持静态 
      run: |
        git clone -j "$(nproc)" --no-tags --shallow-submodules --recurse-submodules --depth 1 --single-branch 'https://github.com/jemalloc/jemalloc.git'
        cd jemalloc
        ./autogen.sh --prefix=/usr --disable-static
        make -j$(nproc)
        make install
        cd ..

    - name: Build Zlib (static)  # 静态构建 Zlib
      run: |
        ZLIB_VERSION=1.3.1
        wget https://zlib.net/zlib-${ZLIB_VERSION}.tar.gz
        tar xzf zlib-${ZLIB_VERSION}.tar.gz
        cd zlib-${ZLIB_VERSION}
        ./configure --prefix=/opt/zlib-static --static
        make -j$(nproc)
        make install
        cd ..

    - name: Build OpenSSL (static)  # 静态构建 OpenSSL
      run: |
        OPENSSL_VERSION=3.5.4
        wget https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz
        tar xzf openssl-${OPENSSL_VERSION}.tar.gz
        cd openssl-${OPENSSL_VERSION}
        mkdir -p /opt/openssl-static/lib  # 创建 lib 子目录
        ./config --prefix=/opt/openssl-static no-shared  # 仅 no-shared
        make -j$(nproc --ignore=2)
        make install  # 完整 install
        # 手动复制静态库到 lib 目录
        cp libssl.a /opt/openssl-static/lib/
        cp libcrypto.a /opt/openssl-static/lib/
        cd ..

    - name: Verify OpenSSL libraries  # 验证 OpenSSL 静态库存在
      run: |
        echo "检查 OpenSSL 静态库文件："
        ls -la /opt/openssl-static/lib/libssl* /opt/openssl-static/lib/libcrypto*
        if [ ! -f /opt/openssl-static/lib/libssl.a ] || [ ! -f /opt/openssl-static/lib/libcrypto.a ]; then
          echo "错误：静态库未找到！"
          exit 1
        else
          echo "静态库验证成功。"
        fi

    - name: Build PCRE2 (static)  # 静态构建 PCRE2
      run: |
        PCRE2_VERSION=10.47
        wget https://github.com/PCRE2Project/pcre2/releases/download/pcre2-${PCRE2_VERSION}/pcre2-${PCRE2_VERSION}.tar.gz
        tar xzf pcre2-${PCRE2_VERSION}.tar.gz
        cd pcre2-${PCRE2_VERSION}
        ./configure --prefix=/opt/pcre2-static --disable-shared --enable-static --enable-jit --enable-unicode
        make -j$(nproc --ignore=2)
        make install
        cd ..

    - name: Build HAProxy (static)  # 静态构建 HAProxy
      run: |
        HAPROXY_VERSION=3.3.0
        wget https://www.haproxy.org/download/3.3/src/haproxy-${HAPROXY_VERSION}.tar.gz
        tar xzf haproxy-${HAPROXY_VERSION}.tar.gz
        cd haproxy-${HAPROXY_VERSION}
        export CC="gcc"
        export LDFLAGS="-static -L/opt/openssl-static/lib -L/opt/zlib-static/lib -L/opt/pcre2-static/lib -lssl -lcrypto -lc -ldl -Wl,-static -static -static-libgcc -s"  # 添加 -ldl 依赖
        make TARGET=linux-glibc \
             ADDLIB="-ljemalloc $(jemalloc-config --libs)" \
             USE_OPENSSL=1 SSL_INC=/opt/openssl-static/include SSL_LIB=/opt/openssl-static/lib \
             USE_ZLIB=1 ZLIB_INC=/opt/zlib-static/include ZLIB_LIB=/opt/zlib-static/lib \
             USE_LUA=1 LUA_INC=/usr/local/include LUA_LIB=/usr/local/lib LUA_LIB_NAME=lua \
             USE_TFO=1 USE_LINUX_TPROXY=1 USE_GETADDRINFO=1 USE_PROMEX=1 USE_SLZ=1 \
             USE_PCRE2=1 USE_PCRE2_JIT=1 USE_STATIC_PCRE2=1 PCRE2_INC=/opt/pcre2-static/include PCRE2_LIB=/opt/pcre2-static/lib \
             USE_THREAD=1 \
             -j$(nproc --ignore=2)
        cd ..

    - name: Prepare and upload binary artifact  # 上传二进制 artifact
      uses: actions/upload-artifact@v4
      with:
        name: haproxy-static-trixie
        path: haproxy-3.3.0/haproxy
        retention-days: 30
